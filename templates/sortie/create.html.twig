{% extends 'base.html.twig' %}

{% form_theme sortieFormCreation 'views/form/Form-template.html.twig' %}

{% block body %}
<main class="w-full p-3">
    <section>
        <div class="p-3 bg-[#D7EAA5] rounded-xl text-neutral-800 shadow-xl">
            <h1 class="text-xl font-medium text-neutral-900 mb-3">Création d'une Sortie</h1>

            {% form_theme sortieFormCreation 'views/form/form-theme.html.twig' %}
            <div class="w-full text-sm">

                {{ form_start(sortieFormCreation) }}
                {{ form_row(sortieFormCreation.nom) }}
                {{ form_row(sortieFormCreation.dateHeureDebut) }}
                {{ form_row(sortieFormCreation.duree) }}
                {{ form_row(sortieFormCreation.dateLimiteInscription) }}
                {{ form_row(sortieFormCreation.nbInscriptionMax) }}
                {{ form_row(sortieFormCreation.infosSortie) }}

                {{ form_row(sortieFormCreation.ville) }}

                <div class="sortie-lieu">
                {{ form_row(sortieFormCreation.lieu) }}
                    <button id="addLieuButton" type="button">+</button>
                    <section class="lieu_details">
                        //TODO renvoyer dans l'appel API la rue, code postal, latitude, longitude ?
                        <p>Rue : </p>
                        <p>Code Postal : </p>
                    </section>
                </div>

                {{ form_row(sortieFormCreation.campus) }}
                {{ form_widget(sortieFormCreation.submit) }}
                {{ form_end(sortieFormCreation) }}

            </div>
        </div>
    </section>
</main>

    <div class="modal-lieu">
        <div class="modal-content">
            <h2>Nouveau lieu</h2>
            <section id="lieu_form" class="form">
                {{ form_start(lieuFormCreation) }}
                {{ form_row(lieuFormCreation.nom) }}
                {{ form_row(lieuFormCreation.rue) }}
                {{ form_row(lieuFormCreation.latitude) }}
                {{ form_row(lieuFormCreation.longitude) }}
                {{ form_row(lieuFormCreation.ville) }}
                {{ form_widget(lieuFormCreation.submit) }}
                {{ form_end(lieuFormCreation) }}
            </section>
        </div>
    </div>

    {% block extraJs %}
        <script>

            // Affichage des lieux correspondant à la ville sélectionnée

            document.addEventListener('DOMContentLoaded', function() {
                const selectVille = document.getElementById('sortie_ville');
                const selectLieu = document.getElementById('sortie_lieu');

                selectVille.addEventListener('input', function() {
                    const villeId = selectVille.value;
                    console.log(villeId)

                    // Vider le select lieu
                    selectLieu.innerHTML = '<option value="">Choisissez un lieu...</option>';

                    if (villeId) { // Si une ville est sélectionnée
                        const apiBaseUrl = '{{ path('sortie_list') }}';
                        fetch(apiBaseUrl + 'api/lieux/' + villeId)
                            .then(response => response.json())
                            .then(data => {
                                // Affichage du nom du lieu dans le select
                                for (const lieu of data) {
                                    const option = document.createElement('option');
                                    option.value = lieu.id;
                                    option.textContent = lieu.nom;
                                    selectLieu.appendChild(option);
                                }
                            });
                    }
                });
                // Affichage de la rue et du cp quand le lieu est renseigné
                const lieuDetails = document.querySelector('.lieu_details');
                selectLieu.addEventListener('input', function (){
                    lieuDetails.style.display = 'flex';
                })
            });

            // Ouverture de la modal au click du +
            let lieu = document.querySelector('.modal-lieu')

            document.querySelector('#addLieuButton').addEventListener('click',function (){
                lieu.style.display = 'flex';
            })

            lieu.addEventListener('click', function(event) {
                if (event.target === lieu) {
                    lieu.style.display = 'none';
                }
            });

            // Traitement du formulaire d'un nouveau lieu dans la modale

            const lieuForm = document.querySelector('#lieu_form');

            lieuForm.addEventListener('submit', function (event){

                event.preventDefault();

                const formData = new formData(lieuForm);
                const data = {
                    nom: formData.get(lieu['nom']),
                    rue: formData.get(lieu['lieu']),

                }
            })



        </script>
    {% endblock %}

{% endblock %}

{% block title %}

{% endblock %}

